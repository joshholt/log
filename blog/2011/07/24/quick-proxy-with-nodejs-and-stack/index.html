
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7" manifest="default.appcache?v=1"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" manifest="default.appcache?v=1" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Major Problem: Quick Proxy With NodeJS and Stack</title>
  <meta name="author" content="Josh Holt">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link href="/log/favicon.png" rel="shortcut icon" />
  <link href="/log/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/log/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/log/javascripts/octopress.js" type="text/javascript"></script>
  <link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
  <link href="/log/atom.xml" rel="alternate" title="The Major Problem" type="application/atom+xml"/>
  

  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</head>

<body  >
  <header><hgroup>
  <h1><a href="/log/">The Major Problem</a></h1>
  
    <h2>one of the many major problems with governing people is that of whom you get to do it; or rather of who manages to get people to let them do it to them.</h2>
  
</hgroup>
</header>
  <nav><ul role="subscription" data-subscription="rss">
  <li><a href="/log/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:joshholt.github.com/log" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/log/">Blog</a></li>
  <li><a href="/log/blog/archives">Archives</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Quick Proxy With NodeJS and Stack</h1>
    
    
      <p class="meta">




<time datetime="2011-07-24 21:11:00 -0400" pubdate  updated >Jul 24<span>th</span>, 2011</time>


</p>
    
  </header>


<div class="entry-content"><h3>So you are building a SPA (Single Page App)</h3>

<p>A single page application, otherwise known as an RIA, etc&#8230; will normally
access endpoints from the server from which it is being served. But let&#8217;s
say that you would like to add some data from Twitter or Flickr or some other
external service. Wouldn&#8217;t it be nice if you could implement a single proxy
endpoint that would allow you to access secure and non-secure external services
painlessly from your RIA?</p>

<h3>If you like the minimalist approach, let&#8217;s get started</h3>

<p>Alright you are sill with me so let&#8217;s get the dependencies out of the way.</p>

<p>First Make sure that you have NodeJS installed <a href="https://github.com/joyent/node/wiki/Installation">Instructions</a>. <br/>
Then Install NPM (Node&#8217;s Package Manager) <a href="http://npmjs.org/">Instructions</a>.</p>

<p>O.K., Now that we have that out of the way let&#8217;s play in the terminal just a bit more</p>

<div><figure role=code><figcaption><span>project_setup.rb </span></figcaption>

<div class="highlight"><pre><code class="rb"><span class="n">mkdir</span> <span class="n">simple_server</span><span class="p">;</span> <span class="n">cd</span> <span class="n">simple_server</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">pv</span> <span class="n">node_modules</span><span class="o">/</span><span class="n">middleware</span>
<span class="n">mkdir</span> <span class="kp">public</span>

<span class="n">npm</span> <span class="n">install</span> <span class="n">simple</span><span class="o">-</span><span class="n">mime</span> <span class="n">stack</span>

<span class="n">touch</span> <span class="n">server</span><span class="o">.</span><span class="n">js</span>
<span class="n">touch</span> <span class="n">node_modules</span><span class="o">/</span><span class="n">proxy</span><span class="o">.</span><span class="n">js</span>
<span class="n">touch</span> <span class="n">node_modules</span><span class="o">/</span><span class="n">middleware</span><span class="o">/</span><span class="n">mount</span><span class="o">.</span><span class="n">js</span>
<span class="n">touch</span> <span class="n">node_modules</span><span class="o">/</span><span class="n">middleware</span><span class="o">/</span><span class="n">static</span><span class="o">.</span><span class="n">js</span>
<span class="n">touch</span> <span class="kp">public</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
<span class="n">echo</span> <span class="s2">&quot;&lt;h1&gt;Welcome to your Simple Server&lt;/h1&gt;&quot;</span> <span class="o">&gt;</span> <span class="kp">public</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
</code></pre>
</div>

</figure></div>


<p>Great, now everything is ready so let&#8217;s start coding shall we?</p>

<p>First let&#8217;s write our middleware for use by stack.<br/>
We will need some middleware to serve our static files and it will be the longest one.<br/>
Place the following code in <code>node_modules/middleware/static.js</code>.</p>

<div><figure role=code><figcaption><span>Static File Middleware (static_middleware.js)</span> <a href='http://joshholt.github.com/log/downloads/code/proxy/static_middleware.js'>download</a></figcaption>

<div class="highlight"><pre><code class="js"><span class="cm">/*globals process unescape*/</span>
<span class="kd">var</span> <span class="nx">Path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">Url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">),</span>
    <span class="nx">Fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">getMime</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;simple-mime&#39;</span><span class="p">)(</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">ENOENT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">ENOENT</span> <span class="o">||</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;constants&#39;</span><span class="p">).</span><span class="nx">ENOENT</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">StreamProto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;net&#39;</span><span class="p">).</span><span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">StreamProto</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;pipe&#39;</span><span class="p">))</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">);</span>
  <span class="nx">StreamProto</span><span class="p">.</span><span class="nx">pipe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sys</span><span class="p">.</span><span class="nx">pump</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">other</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;once&#39;</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">g</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">g</span><span class="p">);</span>
      <span class="nx">listener</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">});</span>
   <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Super simple static file server</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setup</span><span class="p">(</span><span class="nx">mount</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.\.+/g</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">path</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">mount</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">mount</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">mount</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">onStat</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">errno</span> <span class="o">===</span> <span class="nx">ENOENT</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span> <span class="p">}</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&amp;&amp;</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">path</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">Fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">onStat</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Date&quot;</span><span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">toUTCString</span><span class="p">(),</span>
        <span class="s2">&quot;Last-Modified&quot;</span><span class="o">:</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">toUTCString</span><span class="p">()</span>
      <span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;if-modified-since&quot;</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">304</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">range</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> 
          <span class="nx">start</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">end</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">start</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">start</span> <span class="o">||</span> <span class="nx">start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">end</span> <span class="o">&gt;=</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">416</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">code</span> <span class="o">=</span> <span class="mi">206</span><span class="p">;</span>
        <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bytes &quot;</span> <span class="o">+</span> <span class="nx">start</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">end</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getMime</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">ENOENT</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">Fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="p">{</span><span class="nx">start</span><span class="o">:</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="o">:</span> <span class="nx">end</span><span class="p">});</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">Fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">onStat</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre>
</div>

</figure></div>


<p>Then we need a way to mount our proxy endpoints.<br/>
Place the following code in <code>node_modules/middleware/mount.js</code>.</p>

<div><figure role=code><figcaption><span>Endpoint Mounting Middleware (mount_middleware.js)</span> <a href='http://joshholt.github.com/log/downloads/code/proxy/mount_middleware.js'>download</a></figcaption>

<div class="highlight"><pre><code class="js"><span class="kd">var</span> <span class="nx">Url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setup</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">mount</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s2">&quot;uri&quot;</span><span class="p">))</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">===</span> <span class="nx">mount</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre>
</div>

</figure></div>


<p>And last but not least we will need out proxy.<br/>
Place the following code in <code>node_modules/proxy.js</code>.</p>

<div><figure role=code><figcaption><span>Proxy Middleware (proxy_middleware.js)</span> <a href='http://joshholt.github.com/log/downloads/code/proxy/proxy_middleware.js'>download</a></figcaption>

<div class="highlight"><pre><code class="js"><span class="c1">// A Super Simple Proxy</span>
<span class="kd">var</span> <span class="nx">HTTP</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">HTTPS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">proxy_request</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">host</span>  <span class="o">=</span> <span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="kc">true</span><span class="p">).</span><span class="nx">query</span><span class="p">.</span><span class="nx">host</span><span class="p">);</span>
  
  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">host</span><span class="o">:</span> <span class="nx">host</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="nx">host</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;https&#39;</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="mi">80</span><span class="p">),</span>
    <span class="nx">path</span><span class="o">:</span> <span class="nx">host</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span>
  <span class="p">};</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;https&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">proxy_request</span> <span class="o">=</span> <span class="nx">HTTPS</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
    <span class="p">});</span> 
    <span class="nx">proxy_request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">proxy_request</span> <span class="o">=</span> <span class="nx">HTTP</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
    <span class="p">});</span> 
    <span class="nx">proxy_request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
</div>

</figure></div>


<p>Whew, that was a lot to take in but hang in there, we&#8217;re almost finished.<br/>
We are going to bring this all together with the following code.</p>

<div><figure role=code><figcaption><span>Static File Middleware (server.js)</span> <a href='http://joshholt.github.com/log/downloads/code/proxy/server.js'>download</a></figcaption>

<div class="highlight"><pre><code class="js"><span class="cm">/*globals __dirname*/</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;stack/stack&#39;</span><span class="p">)(</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/mount&#39;</span><span class="p">)(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/_proxy&#39;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;proxy&#39;</span><span class="p">)),</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/mount&#39;</span><span class="p">)(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/_proxy&#39;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;proxy&#39;</span><span class="p">)),</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/mount&#39;</span><span class="p">)(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;/_proxy&#39;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;proxy&#39;</span><span class="p">)),</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/mount&#39;</span><span class="p">)(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;/_proxy&#39;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;proxy&#39;</span><span class="p">)),</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/static&#39;</span><span class="p">)(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s2">&quot;/public&quot;</span><span class="p">,</span> <span class="s2">&quot;index.html&quot;</span><span class="p">)</span>
<span class="p">)).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Your site and services are available @ http://0.0.0.0:&quot;</span><span class="o">+</span> <span class="mi">8080</span><span class="p">);</span>
</code></pre>
</div>

</figure></div>


<p>And now we can run our server with the following line in the terminal.</p>

<div><figure role=code><figcaption><span>run_server.sh </span></figcaption>

<div class="highlight"><pre><code class="sh">node server
</code></pre>
</div>

</figure></div>


<p>You can access your simple server <a href="http://0.0.0.0:8080/">here</a>.<br/>
And you can test out the proxy <a href="http://0.0.0.0:8080/_proxy?host=http://api.twitter.com/1/statuses/public_timeline.json?count=3&amp;include_entities=true">here</a>.</p>

<p>Hopefully you will find this minimal example as useful as I have and it will
prove useful when creating you next RIA. All you need to do now is to drop you
RIA code into the public directory and replace the default index.html that we
created earlier in this article.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Josh Holt</span></span>

      




<time datetime="2011-07-24 21:11:00 -0400" pubdate  updated >Jul 24<span>th</span>, 2011</time>



      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://joshholt.github.com/log/blog/2011/07/24/quick-proxy-with-nodejs-and-stack" data-via="cjk2121" data-counturl="http://joshholt.github.com/log/blog/2011/07/24/quick-proxy-with-nodejs-and-stack" >Tweet</a>
  
  
  <g:plusone size="medium"></g:plusone>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'holtsprototype';
  var disqus_identifier = 'http://joshholt.github.com/log/blog/2011/07/24/quick-proxy-with-nodejs-and-stack';
  var disqus_url = 'http://joshholt.github.com/log/blog/2011/07/24/quick-proxy-with-nodejs-and-stack';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

      
        <aside role=sidebar><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/log/blog/2011/07/24/quick-proxy-with-nodejs-and-stack">Quick Proxy With NodeJS and Stack</a>
      </li>
    
      <li class="post">
        <a href="/log/blog/2011/07/24/the-sproutcore-divide">The SproutCore Divide</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("cjk2121", 4, false);
    });
  </script>
  <script src="/log/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/cjk2121" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @cjk2121</a>
  
</section>






</aside>
      
    </div>
  </div>
  <footer><p>
  Copyright &copy; 2011 - Josh Holt -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
</footer>
</body>
</html>
