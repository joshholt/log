
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7" manifest="default.appcache?v=1"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" manifest="default.appcache?v=1" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Major Problem</title>
  <meta name="author" content="Josh Holt">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link href="/log/favicon.png" rel="shortcut icon" />
  <link href="/log/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/log/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/log/javascripts/octopress.js" type="text/javascript"></script>
  <link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
  <link href="/log/atom.xml" rel="alternate" title="The Major Problem" type="application/atom+xml"/>
  

  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</head>

<body  >
  <header><hgroup>
  <h1><a href="/log/">The Major Problem</a></h1>
  
    <h2>one of the many major problems with governing people is that of whom you get to do it; or rather of who manages to get people to let them do it to them.</h2>
  
</hgroup>
</header>
  <nav><ul role="subscription" data-subscription="rss">
  <li><a href="/log/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:joshholt.github.com/log" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/log/">Blog</a></li>
  <li><a href="/log/blog/archives">Archives</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">



  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/log/blog/2011/07/24/quick-proxy-with-nodejs-and-stack">Quick Proxy With NodeJS and Stack</a></h1>
    
    
  </header>


  <div class="entry-content"><h3>So you are building a SPA (Single Page App)</h3>

<p>A single page application, otherwise known as an RIA, etc&#8230; will normally
access endpoints from the server from which it is being served. But let&#8217;s
say that you would like to add some data from Twitter or Flickr or some other
external service. Wouldn&#8217;t it be nice if you could implement a single proxy
endpoint that would allow you to access secure and non-secure external services
painlessly from your RIA?</p>

<h3>If you like the minimalist approach, let&#8217;s get started</h3>

<p>Alright you are sill with me so let&#8217;s get the dependencies out of the way.</p>

<p>First Make sure that you have NodeJS installed <a href="https://github.com/joyent/node/wiki/Installation">Instructions</a>. <br/>
Then Install NPM (Node&#8217;s Package Manager) <a href="http://npmjs.org/">Instructions</a>.</p>

<p>O.K., Now that we have that out of the way let&#8217;s play in the terminal just a bit more</p>

<div><figure role=code><figcaption><span>project_setup.sh </span></figcaption>

<div class="highlight"><pre><code class="sh">mkdir simple_server; <span class="nb">cd </span>simple_server
mkdir -pv node_modules/middleware
mkdir public

npm install simple-mime stack

touch server.js
touch node_modules/proxy.js
touch node_modules/middleware/mount.js
touch node_modules/middleware/static.js
touch public/index.html
<span class="nb">echo</span> <span class="s2">&quot;&lt;h1&gt;Welcome to your Simple Server&lt;/h1&gt;&quot;</span> &gt; public/index.html
</code></pre>
</div>

</figure></div>


<p>Great, now everything is ready so let&#8217;s start coding shall we?</p>

<p>First let&#8217;s write our middleware for use by stack.<br/>
We will need some middleware to serve our static files and it will be the longest one.<br/>
Place the following code in <code>node_modules/middleware/static.js</code>.</p>

<div><figure role=code><figcaption><span>Static File Middleware (static_middleware.js)</span> <a href='http://joshholt.github.com/log/downloads/code/proxy/static_middleware.js'>download</a></figcaption>

<div class="highlight"><pre><code class="js"><span class="cm">/*globals process unescape*/</span>
<span class="kd">var</span> <span class="nx">Path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">Url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">),</span>
    <span class="nx">Fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">getMime</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;simple-mime&#39;</span><span class="p">)(</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">ENOENT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">ENOENT</span> <span class="o">||</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;constants&#39;</span><span class="p">).</span><span class="nx">ENOENT</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">StreamProto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;net&#39;</span><span class="p">).</span><span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">StreamProto</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;pipe&#39;</span><span class="p">))</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">);</span>
  <span class="nx">StreamProto</span><span class="p">.</span><span class="nx">pipe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sys</span><span class="p">.</span><span class="nx">pump</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">other</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;once&#39;</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">g</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">g</span><span class="p">);</span>
      <span class="nx">listener</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">});</span>
   <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Super simple static file server</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setup</span><span class="p">(</span><span class="nx">mount</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.\.+/g</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">path</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">mount</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">mount</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">mount</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">onStat</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">errno</span> <span class="o">===</span> <span class="nx">ENOENT</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span> <span class="p">}</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&amp;&amp;</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">path</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">Fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">onStat</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Date&quot;</span><span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">toUTCString</span><span class="p">(),</span>
        <span class="s2">&quot;Last-Modified&quot;</span><span class="o">:</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">toUTCString</span><span class="p">()</span>
      <span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;if-modified-since&quot;</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">304</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">range</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> 
          <span class="nx">start</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">end</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">start</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">start</span> <span class="o">||</span> <span class="nx">start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">end</span> <span class="o">&gt;=</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">416</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">code</span> <span class="o">=</span> <span class="mi">206</span><span class="p">;</span>
        <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bytes &quot;</span> <span class="o">+</span> <span class="nx">start</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">end</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getMime</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">ENOENT</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">Fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="p">{</span><span class="nx">start</span><span class="o">:</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="o">:</span> <span class="nx">end</span><span class="p">});</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">Fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">onStat</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre>
</div>

</figure></div>


<p>Then we need a way to mount our proxy endpoints.<br/>
Place the following code in <code>node_modules/middleware/mount.js</code>.</p>

<div><figure role=code><figcaption><span>Endpoint Mounting Middleware (mount_middleware.js)</span> <a href='http://joshholt.github.com/log/downloads/code/proxy/mount_middleware.js'>download</a></figcaption>

<div class="highlight"><pre><code class="js"><span class="kd">var</span> <span class="nx">Url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setup</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">mount</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s2">&quot;uri&quot;</span><span class="p">))</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">===</span> <span class="nx">mount</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre>
</div>

</figure></div>


<p>And last but not least we will need out proxy.<br/>
Place the following code in <code>node_modules/proxy.js</code>.</p>

<div><figure role=code><figcaption><span>Proxy Middleware (proxy_middleware.js)</span> <a href='http://joshholt.github.com/log/downloads/code/proxy/proxy_middleware.js'>download</a></figcaption>

<div class="highlight"><pre><code class="js"><span class="c1">// A Super Simple Proxy</span>
<span class="kd">var</span> <span class="nx">HTTP</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">HTTPS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">proxy_request</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">host</span>  <span class="o">=</span> <span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="kc">true</span><span class="p">).</span><span class="nx">query</span><span class="p">.</span><span class="nx">host</span><span class="p">);</span>
  
  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">host</span><span class="o">:</span> <span class="nx">host</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="nx">host</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;https&#39;</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="mi">80</span><span class="p">),</span>
    <span class="nx">path</span><span class="o">:</span> <span class="nx">host</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span>
  <span class="p">};</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;https&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">proxy_request</span> <span class="o">=</span> <span class="nx">HTTPS</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
    <span class="p">});</span> 
    <span class="nx">proxy_request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">proxy_request</span> <span class="o">=</span> <span class="nx">HTTP</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
    <span class="p">});</span> 
    <span class="nx">proxy_request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
</div>

</figure></div>


<p>Whew, that was a lot to take in but hang in there, we&#8217;re almost finished.<br/>
We are going to bring this all together with the following code.</p>

<div><figure role=code><figcaption><span>Static File Middleware (server.js)</span> <a href='http://joshholt.github.com/log/downloads/code/proxy/server.js'>download</a></figcaption>

<div class="highlight"><pre><code class="js"><span class="cm">/*globals __dirname*/</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;stack/stack&#39;</span><span class="p">)(</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/mount&#39;</span><span class="p">)(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/_proxy&#39;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;proxy&#39;</span><span class="p">)),</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/mount&#39;</span><span class="p">)(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/_proxy&#39;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;proxy&#39;</span><span class="p">)),</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/mount&#39;</span><span class="p">)(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;/_proxy&#39;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;proxy&#39;</span><span class="p">)),</span>
    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/mount&#39;</span><span class="p">)(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;/_proxy&#39;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;proxy&#39;</span><span class="p">)),</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;middleware/static&#39;</span><span class="p">)(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s2">&quot;/public&quot;</span><span class="p">,</span> <span class="s2">&quot;index.html&quot;</span><span class="p">)</span>
<span class="p">)).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Your site and services are available @ http://0.0.0.0:&quot;</span><span class="o">+</span> <span class="mi">8080</span><span class="p">);</span>
</code></pre>
</div>

</figure></div>


<p>And now we can run our server with the following line in the terminal.</p>

<div><figure role=code><figcaption><span>run_server.sh </span></figcaption>

<div class="highlight"><pre><code class="sh">node server
</code></pre>
</div>

</figure></div>


<p>You can access your simple server <a href="http://0.0.0.0:8080/">here</a>.<br/>
And you can test out the proxy <a href="http://0.0.0.0:8080/_proxy?host=http://api.twitter.com/1/statuses/public_timeline.json?count=3&amp;include_entities=true">here</a>.</p>

<p>Hopefully you will find this minimal example as useful as I have and it will
prove useful when creating you next RIA. All you need to do now is to drop you
RIA code into the public directory and replace the default index.html that we
created earlier in this article.</p>
</div>
  <footer>
    <a rel="full-article" href="/log/blog/2011/07/24/quick-proxy-with-nodejs-and-stack">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/log/blog/2011/07/24/the-sproutcore-divide">The SproutCore Divide</a></h1>
    
    
  </header>


  <div class="entry-content"><p><strong>*** Disclaimer &#8211; Here be dragons</strong></p>


<p>Now with that out of the way, I would like to talk to you about the confusion you will have when you begin to work with SproutCore in the age of SproutCore 2.0.</p>


<p>I have no doubt that you have been hit with the SproutCore 2.0 Blitz campaign if you are reading this. So lets begin shall we, SproutCore 2.0 is going to be great for the new community and I have no doubts that it will be great for the original community. I mean the folks at strobe are cleaning up a lot of left over code and implement a lot of features we all we attempting to implement in the 1.x line. With that said SproutCore 2.0 still has a ways to go before it will be ready to produce the quality &#8220;desktop like&#8221; applications that we have been accustomed to creating with the SproutCore 1.x line.</p>


<p>That&#8217;s the divide right now and it could be painful in the future if some considerations aren&#8217;t taken into account. What are those considerations you may ask. Well for starters we all know that the focus of SproutCore 2.0 is to be light-weight and easier to pick up. This is a fantastic goal because it has the potential to appeal to a wider base of developers, but here&#8217;s the catch, Those of us that made a bet on SproutCore did so b/c it kicked all of the other frameworks out there in the nuts right out of the box. Did you say right out of the box? Yep and that&#8217;s where that considerations come in to play. With SproutCore 2.0 you get the framework (i.e. KVO, KVC, Bindings and more) but what you don&#8217;t get it the &#8220;desktop like&#8221; feel. Now you could say that I could create this feel my self and most of us re-style the native look and feel anyhow. You would be right, but that was part of the package right?</p>


<p>I am aware of the efforts of Majd Taby on the new &#8220;SproutCore UI&#8221; but from what I can tell from the efforts thus far have been on &#8220;Mobile Style&#8221; navigation and layouts. While this is really good stuff, please don&#8217;t forget that there was and still is a decent size community that live and breath the &#8220;roots&#8221; of SproutCore.</p>


<p>This divide should not exist in the future. When I get asked ( and I often do get asked ) the following question, &#8220;Which version of SproutCore should I use to build a large enterprise application&#8221;, I want to be able to say, &#8220;Just use the latest, you&#8217;ll get the same experience, with a leaner footprint&#8221;. But as it stands today I cannot in earnest give this answer. I have to give the honest answer and tell those folks to use the 1.4.5 - 1.6.x line of SproutCore.</p>


<p>So let&#8217;s build a bridge across the divide and blur the lines drawn in the sand. I&#8217;m more than willing to help in any way. Let&#8217;s not forget SproutCore&#8217;s roots and leave all of the blood, sweat and tears behind for no good reason. Let&#8217;s make it possible for all of the early adopters to come along on the Journey with Strobe. But keep in mind most early adopters in the enterprise adopted early because the &#8220;desktop like&#8221; experience was already there and this is important to them, you see to them agile matters and if it&#8217;s already there that&#8217;s one less thing they have to wast time on.</p>

</div>
  <footer>
    <a rel="full-article" href="/log/blog/2011/07/24/the-sproutcore-divide">Read on &rarr;</a>
  </footer>


  </article>

<nav role="pagination">
  <div>
    
    <a href="/log/blog/archives">Blog Archives</a>
    
  </div>
</nav>

<script type="text/javascript">
    var disqus_shortname = 'holtsprototype';
    (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>

      
        <aside role=sidebar><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/log/blog/2011/07/24/quick-proxy-with-nodejs-and-stack">Quick Proxy With NodeJS and Stack</a>
      </li>
    
      <li class="post">
        <a href="/log/blog/2011/07/24/the-sproutcore-divide">The SproutCore Divide</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("cjk2121", 4, false);
    });
  </script>
  <script src="/log/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/cjk2121" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @cjk2121</a>
  
</section>






</aside>
      
    </div>
  </div>
  <footer><p>
  Copyright &copy; 2011 - Josh Holt -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
</footer>
</body>
</html>
